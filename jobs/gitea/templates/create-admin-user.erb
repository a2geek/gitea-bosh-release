#!/bin/bash

function admin_users {
    chpst -u vcap:vcap /var/vcap/packages/gitea/bin/gitea \
        admin user list \
        --config /var/vcap/jobs/gitea/config/app.ini \
        --admin | grep "true" | wc -l
}


export PATH=/var/vcap/packages/git/bin:$PATH
export HOME=/var/vcap/store/gitea

# Will create the database so we can add the admin user before Gitea runs
chpst -u vcap:vcap /var/vcap/packages/gitea/bin/gitea \
    migrate \
    --config /var/vcap/jobs/gitea/config/app.ini

if [ "$(admin_users)" -eq "0" ]
then
    chpst -u vcap:vcap /var/vcap/packages/gitea/bin/gitea \
        admin user create \
        --config /var/vcap/jobs/gitea/config/app.ini \
        -username <%= p("admin.username") %> \
        --email <%= p("admin.email") %> \
        --password "changeme" \
        --admin --must-change-password
else
    echo "Admin user exists."
fi
