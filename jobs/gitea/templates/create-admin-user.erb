#!/bin/bash

function check_user {
    username="$1"
    password="$2"
    email="$3"
    extra_arg="$4"

    count=$(${GITEA} admin user list \
        --admin | grep "${username}" | wc -l)

    if [ "${count}" -eq "0" ]
    then
        printf 'Adding user "%s".\n' "${username}"
        ${GITEA} admin user create \
            --username "${username}" \
            --email "${email}" \
            --password "${password}" \
            --admin ${extra_arg}
    else
        printf 'Admin user "%s" exists.\n' "${username}"
    fi
}


source /var/vcap/jobs/gitea/config/env.sh

# Will create the database so we can add the admin user before Gitea runs
${GITEA} migrate

check_user '<%= p("admin.username") %>' 'changeme' '<%= p("admin.email") %>' --must-change-password
check_user '<%= p("registration.username") %>' '<%= p("registration.password") %>' 'fake@fake.fake'
